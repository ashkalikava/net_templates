{% if params %}
{%   if params.afi in ['vpnv4', 'l2vpn'] %}
{%     set NEIGHBOR_DEFINITION_ALLOWED = false %}
{%     set PEERGROUP_DEFINITION_ALLOWED = false %}
{%     set peer_groups = routing.bgp.peer_groups | default([]) %}
{%   else %}
{%     set NEIGHBOR_DEFINITION_ALLOWED = true %}
{%     set PEERGROUP_DEFINITION_ALLOWED = true %}
{%     set peer_groups = params.peer_groups | default([]) %}
{%   endif %}
 address-family {{ params.afi }}{% if params.safi %} {{ params.safi }}{% endif %}{% if params.vrf %} vrf {{ params.vrf }}{% endif %}

{%   if params.bgp_additional_paths_install is defined and params.bgp_additional_paths_install is sameas true %}
 bgp additional-paths install
{%   endif %}{# bgp_additional_paths_install #}
{%   if params.bgp_import_path is defined and params.bgp_import_path is mapping %}
{%     if params.bgp_import_path.selection is defined and params.bgp_import_path.selection is string %}
 import path selection {{ params.bgp_import_path.selection }}
{%     endif %}{# params.bgp_import_path.selection #}
{%     if params.bgp_import_path.limit is defined and params.bgp_import_path.limit is number %}
 import path limit {{ params.bgp_import_path.limit }}
{%     endif %}{# params.bgp_import_path.selection #}
{%   endif %}{# params.bgp_import_path #}
{%   if params.redistribute is defined and params.redistribute is iterable %}
{%     for red in params.redistribute %}
 redistribute {{ red.type }}{% if red.route_map is defined %} route-map {{ red.route_map }}{% endif %}{% if red.metric is defined %} metric {{ red.metric }}{% endif %}

{%     endfor %}
{%   endif %}{# if params.redistribute #}
{%   if params.config_lines is defined and params.config_lines is iterable %}
{%     for config_line in params.config_lines %}
{{ config_line }}
{%     endfor %}
{%   endif %}
{%   if params.peer_groups is defined and params.peer_groups is iterable %}
{%     for peer_group in params.peer_groups %}
{%       with indent = 2, params = peer_group %}
{%         include 'ios_routing_bgp_peer_group.j2' %}
{%       endwith %}
{%     endfor %}
{%   endif %}
{%   if params.neighbors is defined and params.neighbors is iterable %}
{%     for neighbor in params.neighbors %}
{%       with indent = 2, params = neighbor %}
{%         include 'ios_routing_bgp_neighbor.j2' %}
{%       endwith %}
{%     endfor %}
{%   endif %}{# params.neighbors is defined #}
 exit-address-family
!
{% endif %}